global:
  resolve_timeout: 5m

inhibit_rules:
  - equal:
      - namespace
      - alertname
    source_matchers:
      - severity = critical
    target_matchers:
      - severity =~ warning|info
  - equal:
      - namespace
      - alertname
    source_matchers:
      - severity = warning
    target_matchers:
      - severity = info
  - equal:
      - namespace
    source_matchers:
      - alertname = InfoInhibitor
    target_matchers:
      - severity = info

receivers:
  - name: 'null'

  # 保留现有的 test receiver
  - name: test
    webhook_configs:
      - http_config:
          tls_config: {}
        send_resolved: true
        url: 'https://www.larksuite.com/flow/api/trigger-webhook/7a6330fc8832cbcf041d329afa784124'

  # 保留现有的 Test lark receiver
  - name: Test lark
    webhook_configs:
      - http_config:
          tls_config: {}
        send_resolved: true
        url: 'https://www.larksuite.com/flow/api/trigger-webhook/6586a5eeb9072e387c56d61532944171'

  # 新增 RisingWave 告警 receiver
  - name: risingwave-webhook
    webhook_configs:
      - url: 'http://rw-cdc-sr.olap.svc.cluster.local:3000/api/webhook/alertmanager'
        send_resolved: true

route:
  group_by:
    - namespace
  group_interval: 5m
  group_wait: 30s
  receiver: 'null'
  repeat_interval: 12h
  routes:
    # RisingWave 告警路由 - 最高优先级
    - match_re:
        alertname: ^RisingWave.*
      receiver: risingwave-webhook
      group_by: ['alertname', 'severity', 'component']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 4h
      routes:
        # Critical 级别 - 每 5 分钟重复
        - match:
            severity: critical
          repeat_interval: 5m
        # Warning 级别 - 每 2 小时重复
        - match:
            severity: warning
          repeat_interval: 2h

    # 保留现有的路由规则
    - match:
        alertname: .*memory_usage_waring*
      match_re:
        alertname: .*mem_warning.*
      receiver: test
      group_by: []
      group_wait: 30s
      group_interval: 2m
      repeat_interval: 3m

    - match: {}
      match_re:
        alertname: .*filessystem_waring.*
      receiver: test
      group_by: []
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 4h

    - match: {}
      match_re:
        alertname: .*instance_.*
      receiver: Test lark
      group_by: []
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 4h

templates:
  - /etc/alertmanager/config/*.tmpl
